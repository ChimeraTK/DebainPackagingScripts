#!/usr/bin/python

import debian.debian_support
import urllib
import subprocess
import os
import sys

# output usage
if len(sys.argv) != 5 :
  print("Usage: ./configureRelease <project_name> <project_version> <distribution_codename> <architecture>")
  print("Example: ./configureRelease DOOCSwrappers 0.5.0 xenial amd64")
  sys.exit()

# parse command line arguments
project = sys.argv[1]
version = sys.argv[2]
splitversion = version.split(".")
soversion = splitversion[0]+"."+splitversion[1]
codename = sys.argv[3]
arch = sys.argv[4]
print("Project: "+project)
print("Version: "+version)
print("SO-Version: "+soversion)
print("Distribution: "+codename)
print("Architecture: "+arch)

# checkout or update the control git repository
if not os.path.isdir("DebianBuildVersions"):
  subprocess.call(["git", "clone", "-q", "git@github.com:ChimeraTK/DebianBuildVersions.git"])
else:
  os.chdir("DebianBuildVersions")
  subprocess.call(["git", "pull", "-q"])
  os.chdir("..")

# read list of dependencies
dependencies = [line.rstrip('\n') for line in open("DebianBuildVersions/"+project+"/DEPENDENCIES")]

print("Searching for dependencies...")

# download Packages file from the DESY DOOCS apt repositories
subprocess.call(["wget", "-q", "http://doocspkgs.desy.de/pub/doocs/dists/"+codename+"/main/binary-"+arch+"/Packages", "-O", "Release.DESY"])

# download Packages file from Ubuntu repositories and unpack
subprocess.call(["wget", "-q", "http://de.archive.ubuntu.com/ubuntu/dists/"+codename+"/main/binary-"+arch+"/Packages.gz", "-O", "Release.MAIN.gz"])
subprocess.call(["gunzip", "-f", "Release.MAIN.gz"])

# download Packages file from Ubuntu repositories and unpack
subprocess.call(["wget", "-q", "http://de.archive.ubuntu.com/ubuntu/dists/"+codename+"/universe/binary-"+arch+"/Packages.gz", "-O", "Release.UNIVERSE.gz"])
subprocess.call(["gunzip", "-f", "Release.UNIVERSE.gz"])

# concatenate both files
subprocess.call(["cat Release.DESY Release.MAIN Release.UNIVERSE > Release"], shell=True)


# open Packages file and parse it
PackageFile = debian.debian_support.PackageFile("Release")
dependency_versions = {}

# search for dependencies
for Package in PackageFile:
  for dependency in dependencies:
    PackageAsDictionary = dict(Package)
    if dependency == PackageAsDictionary["Package"]:
      dependency_versions[dependency] = PackageAsDictionary["Version"]

# check for unfound dependencies
for dependency in dependencies:
  if not dependency in dependency_versions:
    sys.exit("Dependency "+dependency+" cannot be found in the apt repository!")
      
print("")
print("List of dependencies:")

# form the directory name for the build version
version_base_dir=project+"/"+soversion+"/"+codename+"-"+arch
dependency_dir=version_base_dir

build_depends=""
for dependency in dependencies:
  dependency_dir = dependency_dir+"/"+dependency+"-"+dependency_versions[dependency]
  build_depends += dependency+" (= "+dependency_versions[dependency]+"), "
  print("  "+dependency+" (= "+dependency_versions[dependency]+")")
build_depends = build_depends[:-2]

#print("Dependency ID string: "+dependency_dir)
  
# determine build number
if not os.path.isfile("DebianBuildVersions/"+dependency_dir+"/BUILD_NUMBER"):
  # the package has not yet been built with these dependencies
  if not os.path.isfile("DebianBuildVersions/"+version_base_dir+"/LAST_BUILD"):
    print("the package was not yet build in this version for this distribution")
    build_number = 1
    # create the dependency directory with the BUILD_NUMBER file in it
    os.makedirs("DebianBuildVersions/"+dependency_dir)
    f = open("DebianBuildVersions/"+dependency_dir+"/BUILD_NUMBER", 'w')
    f.write(str(build_number))
    f.close()
    # create the link file to the last build
    f = open("DebianBuildVersions/"+version_base_dir+"/LAST_BUILD", 'w')
    f.write(dependency_dir)
    f.close()
  else:
    print("package was already built in this version for this distribution with different dependencies")
    # determine the last build's dependency directory
    f = open("DebianBuildVersions/"+version_base_dir+"/LAST_BUILD", 'r')
    last_build = f.readline().rstrip('\n')
    f.close()
    # determine the build number of the last build, increment by one
    f = open("DebianBuildVersions/"+last_build+"/BUILD_NUMBER", 'r')
    build_number = int(f.readline()) + 1
    f.close()
    # create the dependency directory with the BUILD_NUMBER file in it
    os.makedirs("DebianBuildVersions/"+dependency_dir)
    f = open("DebianBuildVersions/"+dependency_dir+"/BUILD_NUMBER", 'w')
    f.write(str(build_number))
    f.close()
    # create the link file to the last build
    f = open("DebianBuildVersions/"+version_base_dir+"/LAST_BUILD", 'w')
    f.write(dependency_dir)
    f.close()
else:    
  print("package was already built in this version for this distribution with the same dependencies")
  # just read the build number from the dependency directory
  f = open("DebianBuildVersions/"+dependency_dir+"/BUILD_NUMBER", 'r')
  build_number = int(f.readline())
  f.close()

print("Build number: "+str(build_number))

# read config file
configfile = open("DebianBuildVersions/"+project+"/CONFIG",'r').read().splitlines()
config = {}
for line in configfile:
  ( key, value ) = line.split(":", 1)
  config[key.strip()] = value.strip()
  
# extend the config by dynamic variables
config["build-depends"] = build_depends
config["package-basename"] = "lib"+project.lower()
config["architecture"] = arch
config["debversion"] = soversion.replace(".","-")+"-"+codename+str(build_number)
print(config)

# create the Debian control files
controldir="DebianBuildVersions/"+dependency_dir+"/control"
if not os.path.isdir(controldir):
  os.makedirs(controldir)

filelist=[ "control.src" ]
for package in config["Has-packages"].split(" "):
  filelist.append("control."+package.strip())
  
print filelist

for filna in filelist:
  content = open("templates/"+filna).read()
  for var in config.keys():
    content = content.replace("#"+var+"#", config[var])
  print content

#libdoocswrappers#DEBVERSION#, dev-doocs-serverlib (= @DOOCS_VERSION@)


# commit the changes to git
#os.chdir("DebianBuildVersions")
#subprocess.call(["git", "add", "-a" , "."])
#subprocess.call(["git", "commit", "-a" , "-m", "build "+str(build_number)+" of "+version_base_dir])
#subprocess.call(["git", "push"])
#os.chdir("..")

